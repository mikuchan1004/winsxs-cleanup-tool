name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build_and_release:
    name: Build + Publish + GitHub Release
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET (8.x)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        shell: pwsh
        run: |
          dotnet restore

      - name: Build (Release)
        shell: pwsh
        run: |
          dotnet build -c Release --no-restore

      # --------------------------
      # Publish (single-file EXE)
      # --------------------------
      - name: Publish (win-x64, self-contained, single file)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $rid = "win-x64"
          $out = Join-Path $env:GITHUB_WORKSPACE "dist\$rid"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          # csproj가 루트에 있다고 가정 (일반적인 구조)
          # 만약 경로가 다르면 여기만 바꾸면 됨.
          $proj = "WinSxSCleanupTool.csproj"

          dotnet publish $proj -c Release -r $rid `
            --self-contained true `
            -o $out `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true

          Write-Host "Published to: $out"
          Get-ChildItem $out | Select-Object Name, Length

      # --------------------------
      # Package (ZIP + SHA256)
      # --------------------------
      - name: Package (zip)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $tag = "${{ github.ref_name }}"   # vX.Y.Z
          $rid = "win-x64"
          $dist = Join-Path $env:GITHUB_WORKSPACE "dist\$rid"

          if (!(Test-Path $dist)) { throw "dist folder not found: $dist" }

          $zipName = "WinSxSCleanupTool-$tag-$rid.zip"
          $zipPath = Join-Path $env:GITHUB_WORKSPACE $zipName

          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

          Compress-Archive -Path (Join-Path $dist "*") -DestinationPath $zipPath -Force

          $hash = (Get-FileHash -Algorithm SHA256 $zipPath).Hash.ToLower()
          $shaPath = "$zipPath.sha256"
          "$hash  $zipName" | Out-File -Encoding ascii -NoNewline $shaPath

          "ZIP=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "SHA=$shaPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          Write-Host "Created: $zipPath"
          Write-Host "Created: $shaPath"
          Write-Host "SHA256 : $hash"

      # --------------------------
      # Create GitHub Release
      # - Release body from RELEASE_NOTES.md
      # - Upload assets (zip + sha256)
      # --------------------------
      - name: Create GitHub Release (notes + assets)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ env.ZIP }}
            ${{ env.SHA }}
          draft: false
          prerelease: false
