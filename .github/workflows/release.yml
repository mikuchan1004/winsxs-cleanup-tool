name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # tags Ìè¨Ìï®

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish (single-file, self-contained)
        shell: pwsh
        run: |
          dotnet publish `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -o .\_publish\win-x64 `
            /p:PublishSingleFile=true `
            /p:PublishTrimmed=false `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:EnableCompressionInSingleFile=true

      - name: Zip EXE + generate SHA256
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $zip = "WinSxS-Cleanup-Tool-$tag-win-x64.zip"

          $exe = Get-ChildItem .\_publish\win-x64 -Filter *.exe -File | Select-Object -First 1
          if (-not $exe) {
            throw "EXE not found in _publish/win-x64"
          }

          Compress-Archive -Path $exe.FullName -DestinationPath $zip -Force

          $sha = (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower()
          "SHA256  $zip  $sha" | Out-File SHA256.txt -Encoding ascii

          Write-Host "ZIP: $zip"
          Write-Host "SHA256: $sha"

      - name: Prepare release body from RELEASE_NOTES.md (strict)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $notes = "RELEASE_NOTES.md"
          $out = "release_body.md"

          if (-not (Test-Path $notes)) {
            throw "RELEASE_NOTES.md not found."
          }

          $lines = Get-Content $notes
          $start = ($lines | Select-String -SimpleMatch "## $tag").LineNumber
          if (-not $start) {
            throw "Section not found: ## $tag"
          }

          $startIdx = $start - 1
          $endIdx = $lines.Count
          for ($i = $startIdx + 1; $i -lt $lines.Count; $i++) {
            if ($lines[$i] -match '^##\s+v\d+\.\d+\.\d+') {
              $endIdx = $i
              break
            }
          }

          $section = $lines[$startIdx..($endIdx-1)] -join "`n"

          if ($section -match '\(write here\)') {
            throw "Placeholders '(write here)' remain in RELEASE_NOTES.md"
          }

          # Ïù¥Ï†Ñ ÌÉúÍ∑∏ Ï∞æÏïÑ compare ÎßÅÌÅ¨ ÏÉùÏÑ±
          git fetch --tags origin | Out-Null
          $prev = (git tag --list "v*" --sort=-v:refname | Where-Object { $_ -ne $tag } | Select-Object -First 1)

          $repo = "${{ github.repository }}"
          $header = @()

          if ($prev) {
            $header += "üîé Compare: $prev ‚Üí $tag"
            $header += "https://github.com/$repo/compare/$prev...$tag"
            $header += ""
            $header += "---"
            $header += ""
          }

          ($header -join "`n") + $section | Out-File $out -Encoding utf8
          Write-Host "Release body prepared."

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            WinSxS-Cleanup-Tool-*.zip
            SHA256.txt
          body_path: release_body.md
          generate_release_notes: false
