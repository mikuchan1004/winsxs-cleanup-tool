name: Release (Windows x64)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Clean
        run: dotnet clean

      - name: Publish (self-contained, single-file, ko only)
        shell: cmd
        run: >
          dotnet publish WinSxSCleanupTool.csproj
          -c Release
          -r win-x64
          --self-contained true
          -p:PublishSingleFile=true
          -p:EnableCompressionInSingleFile=true
          -p:SatelliteResourceLanguages=ko
          -o Publish

      - name: Remove debug/doc junk
        shell: cmd
        run: >
          del /q Publish\*.pdb 2>nul & del /q Publish\*.xml 2>nul

      - name: Zip (Publish -> artifact)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"      # v1.0.9
          $ver = $tag.TrimStart('v')           # 1.0.9
          $zip = "WinSxSCleanupTool_v$ver_win-x64.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "Publish\*" -DestinationPath $zip -Force
          "ZIP_NAME=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "APP_VER=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Create GitHub Release (templated notes)
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          name: WinSxS Cleanup Tool v${{ env.APP_VER }}
          body: |
            ## ğŸ§¹ WinSxS Cleanup Tool v${{ env.APP_VER }}

            ### âœ¨ ê°œì„  ì‚¬í•­
            - UX ë©”ì‹œì§€ ê°œì„ 
            - ì •ë¦¬/ë¶„ì„ ê²°ê³¼ ìš”ì•½ ê°•ì¡°

            ### ğŸ›  ì•ˆì •í™”
            - Publish êµ¬ì¡° ì•ˆì •í™”
            - Self-contained ë°°í¬ ê²°ê³¼ë¬¼ ì •ë¦¬

            ### ğŸ“¦ ë°°í¬ ì •ë³´
            - Windows x64
            - .NET ëŸ°íƒ€ì„ ë¶ˆí•„ìš” (Self-contained)
            - ZIP ë°°í¬

            ---
            ğŸ“œ ì „ì²´ ë³€ê²½ ë‚´ì—­: [CHANGELOG.md](./CHANGELOG.md)
